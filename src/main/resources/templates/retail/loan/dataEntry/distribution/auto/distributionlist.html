<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="card/layouts/main/main-layout">
<head>
    <meta charset="ISO-8859-1"></meta>
    <title>Auto Distribution List</title>
    <style>
        td {
            word-wrap: break-word;
        }

        button {
            margin-right: 5px;
        }
    </style>
</head>
<body>
<div layout:fragment="content" th:remove="tag">

    <div class="content-wrapper">
        <section class="content">
            <div class="row" id="loan-auto-distribution-list">
                <div class="col-md-12">
                    <div class="box" id="entity-approval">
                        <div class="box-header with-border" style="text-align: center;">
                            <h3 class="box-title">Auto Distribution List</h3>
                        </div>
                        <div class="col-sm-12">
                            <div class="col-sm-2">
                                <button class="btn btn-primary" @click="sendDataToExcel()">Upload Excel</button>
                            </div>
                            <div class="col-sm-6"></div>
                            <div class="col-sm-3">
                                <input v-model="searchField" @click="setSearchField(this)" type="text" class="form-control" placeholder="Search By Account No">
                            </div>
                            <div class="col-sm-1">
                                <button @click="searchButton()" class="btn btn-primary">Search</button>
                            </div>
                        </div>
                        <div class="box-body">

                            <div class="nav-tabs-custom">

                                <div class="tab-content" style="overflow-y: auto; max-height: 45em">
                                    <div class="tab-pane active" id="approval">
                                        <div class="table-responsive">
                                            <table class="table table-condensed table-hover table-bordered"
                                                   style="max-height: 30em" id="loan-auto-distribution-list-table">
                                                <thead class="thead-light">
                                                <tr>
                                                    <td class="text-right" colspan="6">
                                                        <button :disabled="allAccountInformation.number==0" @click="pageRequest($event)" value="p" name="prevoius-btn-table" class="previous round" role="button" type="button">&#8249; Previous</button>
                                                        <button v-show="firstPageButtonShow" @click="pageRequest($event)" :value="0" role="button" type="button">First Page</button>
                                                        <span>Page : {{allAccountInformation.number+1}}</span>
                                                        <span> Of</span>
                                                        <button @click="pageRequest($event)" :value="allAccountInformation.totalPages-1" role="button" type="button">{{allAccountInformation.totalPages}}</button>
                                                        <button :disabled="allAccountInformation.number==allAccountInformation.totalPages" @click="pageRequest($event)" value="n" name="next-btn-table" class="next round" role="button" type="button">&#8250; Next</button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th class="text-right">SL</th>
                                                    <th class="text-center">Account No</th>
                                                    <th class="text-center">Branch Mnemonic</th>
                                                    <th class="text-center">Product Code</th>
                                                    <th class="text-center">Deal Reference</th>
                                                    <th class="text-center">Outstanding</th>
                                                </tr>
                                                </thead>
                                                <tbody class="tbl-row">
                                                <tr v-for="(data, index) in allAccountInformation.content">
                                                    <td>{{indexNumbering() + index+1}}</td>
                                                    <td>{{data.loanACNo}}</td>
                                                    <td>{{data.branchMnemonic}}</td>
                                                    <td>{{data.productCode}}</td>
                                                    <td>{{data.dealReference}}</td>
                                                    <td>{{data.totalOutstanding}}</td>
                                                </tr>
                                                </tbody>
                                                <tfoot>
                                                <tr>
                                                    <td class="text-right" colspan="6">
                                                        <button :disabled="allAccountInformation.number==0" @click="pageRequest($event)" value="p" name="prevoius-btn-table" class="previous round" role="button" type="button">&#8249; Previous</button>
                                                        <button v-show="firstPageButtonShow" @click="pageRequest($event)" :value="0" role="button" type="button">First Page</button>
                                                        <span>Page : {{allAccountInformation.number+1}}</span>
                                                        <span> Of</span>
                                                        <button @click="pageRequest($event)" :value="allAccountInformation.totalPages-1" role="button" type="button">{{allAccountInformation.totalPages}}</button>
                                                        <button :disabled="allAccountInformation.number==allAccountInformation.totalPages" @click="pageRequest($event)" value="n" name="next-btn-table" class="next round" role="button" type="button">&#8250; Next</button>
                                                    </td>
                                                </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                    <!-- /.tab-pane -->

                                </div>
                                <!-- /.tab-content -->
                            </div>

                        </div>
                    </div>


                </div>
            </div>
            <script>
                // var allAccountInformation;
                var allAccountInformationApp = new Vue({
                    el: '#loan-auto-distribution-list',
                    data: {
                        allAccountInformation: [],
                        page: 0,
                        searchField: '',
                        indexPlus: 0,
                        dataToBeInExcel: []
                    },
                    computed: {
                        firstPageButtonShow: function(){
                            if (this.allAccountInformation.number!=0) return true;
                            else return false;
                        }
                    },
                    mounted: function () {
                        this.getAllAccountInformation(this.page, 100, this.searchField)
                    },
                    methods: {
                        getAllAccountInformation: function(page, length, search){
                            var url = "/retail/loan/data-entry/distribution/auto/data/get-pagination?page="+page+"&length="+length;
                            if (search!=''){
                                url= "/retail/loan/data-entry/distribution/auto/data/get-pagination?page="+page+"&search="+search+"&length="+length;
                            }
                            $.ajax({
                                url: url,
                                type: 'GET',
                                dataType: 'json', // added data type
                                success: function(res) {
                                    allAccountInformationApp.allAccountInformation = res;
                                }
                            });
                        },
                        pageRequest: function(e){
                            // console.log(e.target.value);
                            if (e.target.value == "p"){
                                this.page--;
                                this.getAllAccountInformation(this.page, 100, this.searchField)
                                // console.log(e.target.value);
                            } else if (e.target.value == "n") {
                                this.page++;
                                this.getAllAccountInformation(this.page, 100, this.searchField)
                                // console.log(e.target.value);
                            } else {
                                this.page=parseInt(e.target.value);
                                this.getAllAccountInformation(this.page, 100, this.searchField)
                            }
                        },
                        searchButton: function(){
                            if (this.searchField != '') {
                                this.getAllAccountInformation(0, 100, this.searchField);
                            }
                        },
                        setSearchField: function(e){
                            this.searchField = e.value;
                        },
                        indexNumbering: function(){
                            if (this.allAccountInformation.number != 0){
                                return this.indexPlus = this.allAccountInformation.number * 100;
                            } else{
                                return this.indexPlus = 0;
                            }
                        },
                        sendDataToExcel: function(){
                            var dateString = new Date().toJSON();
                            allAccountInformationApp.dataToBeInExcel = this.allAccountInformation.content;
                            var CsvString = "";
                            CsvString += "Loan Account No, Employee Id, Employee Name, Branch Mnemonic, Product Code, Deal Reference \r\n";
                            allAccountInformationApp.dataToBeInExcel.forEach(function(RowItem, RowIndex) {
                                CsvString += RowItem.loanACNo!=null?"'"+RowItem.loanACNo:''; + ',';
                                CsvString += ", , , ";
                                CsvString += RowItem.branchMnemonic!=null?"'"+RowItem.branchMnemonic:''; + ',';
                                CsvString += RowItem.productCode!=null?"'"+RowItem.productCode:''; + ',';
                                CsvString += RowItem.dealReference!=null?"'"+RowItem.dealReference:''; + ',';
                                CsvString += "\r\n";
                            });
                            CsvString = "data:application/csv," + encodeURIComponent(CsvString);
                            var x = document.createElement("A");
                            x.setAttribute("href", CsvString );
                            x.setAttribute("download",("loan_distribution_"+dateString+".csv"));
                            document.body.appendChild(x);
                            x.click();
                        },
                    }
                })
            </script>
        </section>
    </div>
</div>
</body>
</html>