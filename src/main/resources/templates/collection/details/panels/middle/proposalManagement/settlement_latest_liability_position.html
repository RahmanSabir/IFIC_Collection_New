<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="ISO-8859-1"/>
    <title>Latest Liability Position as Per Loan Listing</title>
</head>

<body>
<div th:fragment="settlement-latest-liability-position">
    <div class="csi-view-form-full-area csi-view-indtable" id="reportOne">
        <div class="box-header with-border csi-view-box-header">
            <h3 class="box-title">Latest Liability Position as Per Loan Listing</h3>
            <a class=" btn btn-xs btn-primary pull-right btn-add-customer-request" data-toggle="modal" data-target="#modal-settlement-latest-liability-position" >
                <i class="fa fa-plus-square"></i>
                Add More
            </a>
        </div>

        <div class="box-body">
            <div class="row">
                <div class="modal fade in" id="modal-settlement-latest-liability-position"  data-backdrop="static" data-keyboard="false">
                    <div class="modal-dialog" style="width: 60%">
                        <div class="modal-content col-sm-12">
                            <div class="modal-header">
                                <h3 >Latest Liability Position as Per Loan Listing</h3>
                            </div>

                            <form  id="form-settlement-latest-liability-position" action="" method="post" class="form-horizontal" >
                                <input name="_csrf" type="hidden">
                                <input name="customerId" type="hidden">
                                <input type="hidden" name="id" id="settlement_liability_id"/>
                                
                                <div class="modal-body">
                                    <div class="form-group col-sm-12">
                                        <label class="col-sm-2 custom-details-lebel-left">Nature of A/C:</label>
                                        <div class="col-sm-4">
                                            <input type="text" id="natureOfAccount" name="natureOfAccount"  class="form-control" placeholder="Nature of A/C" style="height: 25px"></input>
                                        </div>
                                        <label class="col-sm-2 custom-details-lebel-left">A/C Number:</label>
                                        <div class="col-sm-4">
                                            <input type="text" id="liabilityAccountNo" name="accountNo" class="form-control" placeholder="Account No." style="height: 25px"></input>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group col-sm-12">
                                        <label class="col-sm-2 custom-details-lebel-left">Sanction on date:</label>
                                        <div class="col-sm-4">
                                            <input type="date" id="sanctionOnDate" name="sanctionOnDate"  class="form-control" placeholder="Sanction on date"></input>
                                        </div>
                                        <label class="col-sm-2 custom-details-lebel-left">Validity:</label>
                                        <div class="col-sm-4">
                                            <input type="text" id="validity" name="validity"  class="form-control" placeholder="Validity"></input>
                                        </div>
                                    </div>

                                    <div class="form-group col-sm-12">
                                        <label class="col-sm-2 custom-details-lebel-left">Limit:</label>
                                        <div class="col-sm-4">
                                            <input type="number" id="limit" name="limit"  class="form-control" placeholder="Limit"></input>
                                        </div>
                                        <label class="col-sm-2 custom-details-lebel-left">Rate of Int:</label>
                                        <div class="col-sm-4">
                                            <input type="number" id="rateOfInt" name="rateOfInt"  class="form-control" placeholder="Rate of Int"></input>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group col-sm-12">
                                        <label class="col-sm-2 custom-details-lebel-left">Outstanding:</label>
                                        <div class="col-sm-4">
                                            <input type="number" id="outstandingLiability" name="outstanding"  class="form-control" placeholder="Outstanding"></input>
                                        </div>
                                        <label class="col-sm-2 custom-details-lebel-left">Suspense As on:</label>
                                        <div class="col-sm-4">
                                            <input type="text" id="suspenseAsOn" name="suspenseAsOn"  class="form-control" placeholder="Suspense As on"></input>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group col-sm-12">
                                        <label class="col-sm-2 custom-details-lebel-left">Unapplied As on:</label>
                                        <div class="col-sm-4">
                                            <input type="text" id="unappliedAsOn" name="unappliedAsOn"  class="form-control" placeholder="Unapplied As on"></input>
                                        </div>
                                        <label class="col-sm-2 custom-details-lebel-left">AMT:</label>
                                        <div class="col-sm-4">
                                            <input type="text" id="aMT" name="aMT"  class="form-control" placeholder="AMT"></input>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group col-sm-12">
                                        <label class="col-sm-2 custom-details-lebel-left">Month:</label>
                                        <div class="col-sm-4">
                                            <input type="date" id="month" name="month"  class="form-control" placeholder="Month"></input>
                                        </div>
                                        <label class="col-sm-2 custom-details-lebel-left">EI. Sec.:</label>
                                        <div class="col-sm-4">
                                            <input type="text" id="ciSec" name="ciSec"  class="form-control" placeholder="EI. Sec."></input>
                                        </div>
                                    </div>

                                    <div class="form-group col-sm-12">
                                        <label class="col-sm-2 custom-details-lebel-left">CL Status:</label>
                                        <div class="col-sm-4">
                                            <select id="settlment-table-latest-liability-position-clstatus" name="cLStatus" class="form-control">
                                                <option value="0">Select CL Status</option>
                                            </select>
                                        </div>

                                    </div>
                                </div>

                                <div class="modal-footer text-center">
                                    <button type="submit" class="btn btn-info">Save</button>
                                    <button type="button" id="cardRefModalCancelBtn" class="btn btn-danger" data-dismiss="modal">Close</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-horizontal csi-view-form">
                <div style="overflow: auto; max-height: 400px;">
                    <table type="datatable-responsive" id="settlment-table-latest-liability-position"
                           class="table table-striped table-bordered table-condensed" width="100%">
                        <thead>
                        <tr>
                            <td rowspan="2">SL</td>
                            <td rowspan="2">Nature of A/C</td>
                            <td rowspan="2">A/C Number</td>
                            <td rowspan="2">Sanction on date</td>
                            <td rowspan="2">Validity</td>
                            <td rowspan="2">Limit</td>
                            <td rowspan="2">Rate of Int</td>
                            <td rowspan="2">Outstanding</td>
                            <td colspan="2" style="text-align: center">Interest</td>
                            <td colspan="2" style="text-align: center">Overdue</td>
                            <td rowspan="2">El. Sec.</td>
                            <td rowspan="2">CL Status</td>
                            <td rowspan="2">Action</td>
                        </tr>
                        <tr>
                            <td>Suspense As on</td>
                            <td>Unapplied As on</td>
                            <td>AMT</td>
                            <td>Month</td>
                        </tr>
                        </thead>
                        
                        <tbody id="settlement-tbody-latest-liability-position"></tbody>
                    </table>
                </div>
            </div>

            <script>
                $(document).ready(function () {
                    $('#form-settlement-latest-liability-position input[name="_csrf"]').val(csrfToken);
                    $('#form-settlement-latest-liability-position input[name="customerId"]').val(customerId)

                    function getSettlementLatestLiabilityPosition() {
                        $.getJSON('/collection/samd/data-entry/settlement-latest-liability-loan-listing/list?customerId='+customerId, function (json) {
                            var tr = "";

                            for (i = 0; i < json.length; i++){
                                tr += ('<tr>');
                                    tr += ('<td>' + (i+1) + '</td>');

                                    tr += ('<td>' + (json[i].natureOfAccount == null ? '' : json[i].natureOfAccount) + '</td>');
                                    tr += ('<td>' + (json[i].accountNo == null ? '' : json[i].accountNo) + '</td>');
                                    tr += ('<td>' + (json[i].sanctionOnDate == null ? '' : formatDate(json[i].sanctionOnDate)) + '</td>');
                                    tr += ('<td>' + (json[i].validity == null ? '' : json[i].validity) + '</td>');
                                    tr += ('<td>' + (json[i].limit == null ? '' : json[i].limit) + '</td>');

                                    tr += ('<td>' + (json[i].rateOfInt == null ? '' : json[i].rateOfInt) + '</td>');
                                    tr += ('<td>' + (json[i].outstanding == null ? '' : json[i].outstanding) + '</td>');
                                    tr += ('<td>' + (json[i].suspenseAsOn == null ? '' : json[i].suspenseAsOn) + '</td>');
                                    tr += ('<td>' + (json[i].unappliedAsOn == null ? '' : json[i].unappliedAsOn) + '</td>');

                                    tr += ('<td>' + (json[i].amt == null ? '' : json[i].amt) + '</td>');
                                    tr += ('<td>' + (json[i].month == null ? '' : formatDate(json[i].month)) + '</td>');
                                    tr += ('<td>' + (json[i].ciSec == null ? '' : json[i].ciSec) + '</td>');
                                    tr += ('<td>' + (json[i].clstatus == null ? '' : json[i].clstatus.name) + '</td>');

                                    tr += ('<td><a class="btn btn-primary btn-xs" id="edit-settlement-latest-liability-loan" data-toggle="modal" data-target="#modal-settlement-latest-liability-position" data-id = "'+json[i].id+'" <i class="fa fa-edit"></i>Edit</a></td>');
                                tr += ('</tr>')
                            }

                            $('#settlement-tbody-latest-liability-position').html(tr);
                        })

                    }

                    $('#tab-settlement-latest-liability-position').on('click', function () {
                        getSettlementLatestLiabilityPosition();
                        getSettlementLatestLiabilityPositionClStatus();
                    })
                    
                    function getSettlementLatestLiabilityPositionClStatus(){
                        $.ajax({
                            url: '/collection/samd/data-entry/settlement-latest-liability-loan-listing/cl-status',
                            success: function (response) {
                                let options = "<option value=''>Select CL Status</option>";
                                $.each(response, function (index, data) {
                                    options += "<option value='"+data.id+"'>"+data.name+"</option>";
                                })
                                $('#settlment-table-latest-liability-position-clstatus').html(options);
                            },
                            error: function (response) {
                                alert("Unsuccessful");
                            }
                        })
                    }

                    $('#form-settlement-latest-liability-position').on('submit', function (e) {
                        e.preventDefault();
                        var data = new FormData(this);

                        $.ajax({
                            type:'POST',
                            url: '/collection/samd/data-entry/settlement-latest-liability-loan-listing/save',
                            data: data,
                            processData: false,
                            contentType: false,
                            headers: {
                                'X-CSRF-TOKEN': window.csrfToken,
                            },
                            success: function (response, xhr, status) {
                                $('#modal-settlement-latest-liability-position').modal('toggle');
                                $('#modal-settlement-latest-liability-position').find("input:not(:hidden)").val("");
                                $('#settlement_liability_id').val('');
                                $('#settlement-tbody-latest-liability-position').html("");
                                getSettlementLatestLiabilityPosition();
                                swal("Saved Successfully");

                            },
                            error: function (response) {
                                alert("Unsuccessful")
                            }
                        })
                    })


                    $("tbody").delegate("#edit-settlement-latest-liability-loan", "click", function () {
                        console.log();
                        $.ajax({
                            url: '/collection/samd/data-entry/settlement-latest-liability-loan-listing/edit?id='+$(this).data('id'),
                            success: function (response) {
                                $('#settlement_liability_id').val(response.id);
                                $('#natureOfAccount').val(response.natureOfAccount);
                                $('#liabilityAccountNo').val(response.accountNo);
                                $('#sanctionOnDate').val(formatDateInput(response.sanctionOnDate));
                                
                                $('#validity').val(response.validity);
                                $('#limit').val(response.limit);
                                $('#rateOfInt').val(response.rateOfInt);
                                $('#outstandingLiability').val(response.outstanding);
                                
                                $('#suspenseAsOn').val(response.suspenseAsOn);
                                $('#unappliedAsOn').val(response.unappliedAsOn);
                                $('#aMT').val(response.amt);
                                $('#month').val(formatDateInput(response.month));
                                
                                $('#ciSec').val(response.ciSec);
                                $('#settlment-table-latest-liability-position-clstatus').val(response.clstatus == null ? '' : response.clstatus.id);

                            },
                            error: function (response) {
                                console.log("Something went wrong.")
                            }
                        })
                    })

                    function formatDateInput(date) {
                        let date1 = date ? new Date(date) : new Date()

                        return date ? date1.getFullYear()
                            +'-'+((date1.getMonth()+1) < 10 ? '0'+(date1.getMonth()+1) : (date1.getMonth()+1))
                            +'-'+(date1.getDate() < 10 ? '0'+date1.getDate() : date1.getDate())
                            : '';
                    }

                    function formatDate(date) {
                        return formatDate_DD_MMM_YYYY(date)
                    }

                })
            </script>
        </div>
    </div>
</div>
</body>
</html>