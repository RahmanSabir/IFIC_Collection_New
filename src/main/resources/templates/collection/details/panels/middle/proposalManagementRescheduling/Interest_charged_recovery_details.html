<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="ISO-8859-1"/>
    <title>Interest Charged/Recovery Details</title>
</head>
<body>

<div id="layout-cibReport" th:fragment="interest-charged-recovery-details">
    <div class="csi-view-form-full-area csi-view-indtable" id="reportOne">
        <div class="box-header with-border csi-view-box-header">
            <h3 class="box-title">Interest Charged/ Settlement/ Recovery Details</h3>
            <div class="pull-right">

                <a class=" btn btn-xs btn-primary  btn-add-customer-request" data-toggle="modal"
                   data-target="#modal-reschedule-guideline">
                    <i class="fa fa-eye"></i>
                    Reschedule Guideline
                </a>

                <div class="text-right" style="margin-top: 5px;">
                    <a class=" btn btn-xs btn-primary pull-right btn-add-customer-request" data-toggle="modal" data-target="#modal-interest-charged-recovery-details" >
                        <i class="fa fa-plus-square"></i>
                        Add More
                    </a>
                </div>
            </div>
        </div>

        <div class="box-body">
            <div class="row">
                <div class="modal fade in" id="modal-interest-charged-recovery-details"  data-backdrop="static" data-keyboard="false">
                    <div class="modal-dialog" style="width: 60%">
                        <div class="modal-content col-sm-12">
                            <div class="modal-header">
                                <h3 >Interest Charged/ Settlement/ Recovery Details</h3>
                            </div>

                            <form id="interest-charged-recovery-details-form"  action="" method="post" class="form-horizontal" >
                                <input name="_csrf" type="hidden">
                                <input name="customerId" type="hidden">

                                <div class="alert alert-warning hidden" id="interest-charged-recovery-error-messages"></div>

                                <div class="modal-body">
                                    <div class="form-group col-sm-12">
                                        <label class="col-sm-2 custom-details-lebel-left">Year:</label>
                                        <div class="col-sm-4">
                                            <select id="interest-charged-year-Select" class="form-control" name="year">
                                            </select>
                                        </div>
                                    </div>
                                    <div id="hidden-params" class="hidden">
                                        <div class="form-group col-sm-12">
                                            <label class="col-sm-2 custom-details-lebel-left">Interest Charged:</label>
                                            <div class="col-sm-4">
                                                <input type="number" name="interestCharged" class="form-control" placeholder="Interest Charged"></input>
                                            </div>
                                            <label class="col-sm-2 custom-details-lebel-left">Interest Suspense:</label>
                                            <div class="col-sm-4">
                                                <input type="number" name="interestSuspense" class="form-control" placeholder="Interest Suspense"></input>
                                            </div>
                                        </div>
                                        <div class="form-group col-sm-12">
                                            <label class="col-sm-2 custom-details-lebel-left">Recovery:</label>
                                            <div class="col-sm-4">
                                                <input type="number" name="recovery" class="form-control" placeholder="Recovery"></input>
                                            </div>
                                            <label class="col-sm-2 custom-details-lebel-left">Settlement Recovery:</label>
                                            <div class="col-sm-4">
                                                <input type="number" name="settlementRecovery" class="form-control" placeholder="Settlement Recovery"></input>
                                            </div>
                                        </div>
                                    </div>

                                </div>

                                <div class="modal-footer text-center">
                                    <button type="submit" class="btn btn-info">Save</button>
                                    <button type="button" id="cardRefModalCancelBtn" class="btn btn-danger" data-dismiss="modal">Close</button>
                                </div>
                            </form>

                            <script>
                                $(document).ready(function () {

                                    $('#interest-charged-recovery-details-form input[name="_csrf"]').val(csrfToken);
                                    $('#interest-charged-recovery-details-form input[name="customerId"]').val(customerId)


                                    $('#interest-charged-year-Select').change(function () {
                                        let year = $(this).val()
                                        let elem = $('#hidden-params');
                                        if(!year){
                                            elem.addClass('hidden')
                                        }
                                        else {
                                            elem.removeClass('hidden')
                                        }
                                    })

                                    function interestChargedRecoveryDetails() {
                                        $.getJSON('/collection/samd/data-entry/proposal-management-rescheduling/interest-charged-recovery-details/list?customerId='+customerId, function (json) {
                                            formData = json;
                                            let thead = "", totalAllYear = [0, 0, 0, 0], totalYears = 0, startYear, endYear;
                                            $('.interest-year-data').remove();

                                            $.each(json, function(index, charge){
                                                if (index == 0) startYear = charge.year
                                                endYear = charge.year

                                                thead += "<th class='interest-year-data'>"+charge.year+"</th>"

                                                $('#charge-details-table tbody > tr:eq(0)').append("<td class='interest-year-data'>"+charge.interestCharged+"</td>")
                                                totalAllYear[0] += Number(charge.interestCharged)

                                                $('#charge-details-table tbody > tr:eq(1)').append("<td class='interest-year-data'>"+charge.interestSuspense+"</td>")
                                                totalAllYear[1] += Number(charge.interestSuspense)

                                                $('#charge-details-table tbody > tr:eq(2)').append("<td class='interest-year-data'>"+charge.recovery+"</td>")
                                                totalAllYear[2] += Number(charge.recovery)

                                                $('#charge-details-table tbody > tr:eq(3)').append("<td class='interest-year-data'>"+charge.settlementRecovery+"</td>")
                                                totalAllYear[3] += Number(charge.settlementRecovery)

                                                let totalYearWise = Number(charge.recovery) + Number(charge.settlementRecovery)
                                                $('#charge-details-table tbody > tr:eq(4)').append("<td class='interest-year-data'>"+totalYearWise+"</td>")
                                                totalYears += totalYearWise
                                            })

                                            let message = (startYear == endYear) ? startYear : startYear + " to " + endYear
                                            thead += "<th class='interest-year-data'>Total ("+message+")</th>"

                                            $('#charge-details-table thead > tr').append(thead);

                                            $('#charge-details-table tbody > tr:eq(0)').append("<td class='interest-year-data'>"+totalAllYear[0]+"</td>")
                                            $('#charge-details-table tbody > tr:eq(1)').append("<td class='interest-year-data'>"+totalAllYear[1]+"</td>")
                                            $('#charge-details-table tbody > tr:eq(2)').append("<td class='interest-year-data'>"+totalAllYear[2]+"</td>")
                                            $('#charge-details-table tbody > tr:eq(3)').append("<td class='interest-year-data'>"+totalAllYear[3]+"</td>")
                                            $('#charge-details-table tbody > tr:eq(4)').append("<td class='interest-year-data'>"+totalYears+"</td>")
                                        })

                                    }


                                    $('#tab-InterestChargedDetails').on('click', function () {

                                        interestChargedRecoveryDetails();

                                        let years = '<option value="">Select year</option>';
                                        let year = new Date().getFullYear();
                                        while (year > 1900){
                                            years += '<option value="'+year+'">'+year+'</option>'
                                            year -= 1;
                                        }

                                        $('#interest-charged-year-Select').html(years)
                                    })


                                    $('#interest-charged-recovery-details-form').on('submit', function (e) {
                                        e.preventDefault();
                                        var data = new FormData(this);
                                        var formdatalist = $('#interest-charged-recovery-details-form');

                                        var interestCharged = formdatalist.find('input[name="interestCharged"]').val();
                                        var interestSuspense = formdatalist.find('input[name="interestSuspense"]').val();
                                        var recovery = formdatalist.find('input[name="recovery"]').val();
                                        var settlementRecovery = formdatalist.find('input[name="settlementRecovery"]').val();


                                        if (interestCharged == ''){
                                            $('#interest-charged-recovery-error-messages').text("Interest charged can not be blank.").removeClass('hidden')
                                            return;
                                        }else if (!$.isNumeric(interestCharged)){
                                            $('#interest-charged-recovery-error-messages').text("Interest charged must be number.").removeClass('hidden');
                                            return;
                                        }


                                        if (interestSuspense == ''){
                                            $('#interest-charged-recovery-error-messages').text("Interest suspense can not be blank.").removeClass('hidden')
                                            return;
                                        }else if (!$.isNumeric(interestSuspense)){
                                            $('#interest-charged-recovery-error-messages').text("Interest suspense must be number.").removeClass('hidden');
                                            return;
                                        }


                                        if (recovery == ''){
                                            $('#interest-charged-recovery-error-messages').text("Recovery can not be blank.").removeClass('hidden')
                                            return;
                                        }else if (!$.isNumeric(recovery)){
                                            $('#interest-charged-recovery-error-messages').text("Recovery must be number.").removeClass('hidden');
                                            return;
                                        }

                                        if (settlementRecovery == ''){
                                            $('#interest-charged-recovery-error-messages').text("Settlement recovery can not be blank.").removeClass('hidden')
                                            return;
                                        }else if (!$.isNumeric(settlementRecovery)){
                                            $('#interest-charged-recovery-error-messages').text("Settlement recovery must be number.").removeClass('hidden');
                                            return;
                                        }



                                        $.ajax({
                                            type:'POST',
                                            url: '/collection/samd/data-entry/proposal-management-rescheduling/interest-charged-recovery-details/save',
                                            data: data,
                                            processData: false,
                                            contentType: false,
                                            headers: {
                                                'X-CSRF-TOKEN': window.csrfToken,
                                            },
                                            success: function (response, xhr, status) {
                                                $('#modal-interest-charged-recovery-details').modal('toggle');
                                                $('#modal-interest-charged-recovery-details').find("input:not(:hidden)").val("");
                                                $('#liability-discussion-body').html("");
                                                interestChargedRecoveryDetails();
                                                swal("Saved Successfully");

                                            },
                                            error: function (response) {
                                                alert("Unsuccessful")
                                            }
                                        })
                                    })

                                })
                            </script>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-horizontal csi-view-form">
                <div style="overflow: auto; max-height: 400px;">
                    <table type="datatable-responsive" id="charge-details-table"
                           class="table table-striped table-bordered table-condensed" width="100%">
                        <thead>
                        <tr>
                            <td colspan="2">Interest Charged/ Settlement/ Recovery Details: </td>
                        </tr>

                        </thead>
                        <tbody>
                            <tr>
                                <td>a</td>
                                <td>Interest Charged (for existing accounts mention in the list)</td>
                            </tr>
                            <tr>
                                <td>b</td>
                                <td>Interest Suspense (for existing accounts mention in the list)</td>
                            </tr>
                            <tr>
                                <td>c</td>
                                <td>Recovery (for existing accounts mention in the list)</td>
                            </tr>
                            <tr>
                                <td>d</td>
                                <td>Recovery (for existing accounts mention in the list)</td>
                            </tr>
                            <tr>
                                <td colspan="2">Total Recovery Amount</td>
                            </tr>

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
</body>


</html>
