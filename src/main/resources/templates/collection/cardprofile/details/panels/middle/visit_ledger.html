<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="ISO-8859-1"/>
        <title>Visit Ledger </title>
    </head>
<body>
<div id="layout-cibReport" th:fragment="visit-ledger">
    <div id="visit-ledger-view-id">
        <div class="modal fade" id="modal-visit-ledger-view">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">Visit Ledger</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row form-group">
                            <label  class="col-sm-2 custom-form-lebel-right">Remark: </label>
                            <div class="col-sm-10">
                                <textarea  name="remark" id="supervisor-visitledger-remark" class="form-control"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Close</button>
                    </div>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
        </div>
    <div class="csi-view-form-full-area csi-view-indtable">
        <!-- Modal -->
        <div id="visitLedgerCardModal" class="modal fade" role="dialog">
            <div class="modal-dialog modal-lg">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <!--<h4 class="modal-title">Add Visit Ledger</h4>-->
                    </div>
                    <form id="visit-ledger-from-id" action="" method="post" class="form-horizontal">
                        <input type="hidden" id="visitLedgerId" name="id"/>
                        <input name="_csrf" value="" type="hidden">
                        <input type="hidden" name="accountCardNumber" :value="accountNo">
                        <div class="modal-body">
                            <div class="modal-body">

                                <!-- select -->
                                <div class="form-group">
                                    <label class="col-sm-2 control-label required">Card Account </label>
                                    <div class="col-sm-4">
                                        <input type="text" name="accountCardNumber" id="accountCardNumber-id" :value="accountNo" class="form-control" disabled="disabled" />
                                    </div>

                                    <label class="col-sm-2 control-label required">Account Type</label>
                                    <div class="col-sm-4">
                                        <label>
                                            <input type="radio" class ="cheker" name="productUnit" value="Card" checked="true"> Card
                                        </label>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="vl_loan_date" class="col-sm-2 control-label required">Date</label>
                                    <div class="col-sm-4">
                                        <div class="input-group date">
                                            <div class="input-group-addon">
                                                <i class="fa fa-calendar"></i>
                                            </div>
                                            <input type="date" name="dateOfVisit" id="vl_loan_date" class="form-control pull-right" required="required" />
                                        </div>
                                    </div>

                                    <label for="card_ptp_time" class="col-sm-2 control-label">Time</label>
                                    <div class="col-sm-4">
                                        <div class="input-group">
                                            <div class="input-group-addon">
                                                <i class="fa fa-clock-o"></i>
                                            </div>
                                            <input type="time" name="visitTime" class="form-control"
                                                   id="card_ptp_time" placeholder="12:00 PM"/>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-2 control-label">Visit Location *</label>
                                    <div class="col-sm-10">
                                        <!--<input type="text" class="form-control" id="vl_loan_location" name="location" placeholder="Visit Location" required="required" />-->
                                        <select class="form-control" name="location">
                                            <option value="">Select Location</option>
                                            <option v-for="address in allAddress" :value="address" v-if="!!address">{{address}}</option>
                                        </select>
                                    </div>
                                </div>


                                <div class="form-group">
                                    <label for="vl_loan_remark" class="col-sm-2 control-label ">Remarks</label>
                                    <div class="col-sm-10">
                                        <textarea class="form-control" rows="3" style="resize: none" placeholder="Enter Details Here" name="remark" id="vl_loan_remark"></textarea>
                                    </div>
                                </div>

                                <span></span>

                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Save</button>
                            <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                        </div>

                    </form>
                </div>

            </div>
        </div>
        <!--<div class="box-header with-border csi-view-box-header">
            <h3 class="box-title" >Visit Ledger</h3>
        </div>-->
        <div class="box-header with-border csi-view-box-header">
            <h3 class="box-title" >Visit Ledger</h3>
            <a class=" btn btn-primary btn-sm pull-right" id="visit_ledger_card_add" @click="resetForm()" data-toggle="modal" data-target="#visitLedgerCardModal">
                <i class="fa fa-plus-square"></i>
                Add More
            </a>
        </div>
        <div class="box-body" >

            <div class="form-horizontal csi-view-form" id="referenceInfo">
                <input class="gen-card-id" type="hidden"  name="cardId" th:value="${cdi}" />
                <input type="hidden" name="refId" id="refId" th:value="${refId}"  />
                <!--<table class=" table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Dealer Name</th>
                            <th>Visit Date</th>
                            <th>Visit Time</th>
                            <th>Location</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="visit :${visitLedger}">
                            <td th:text="${visit.getName()}"></td>
                            <td th:text="${visit.getVisitDate()}"></td>
                            <td th:text="${visit.getVisitTime()}"></td>
                            <td th:text="${visit.getLocation()}"></td>

                        </tr>
                    </tbody>
                </table>-->
                <table class=" table table-striped table-bordered" style="overflow: auto;width: 100%;">
                    <thead>
                    <tr>
                        <th>Dealer Name</th>
                        <th>Visit Date</th>
                        <th>Visit Time</th>
                        <th>Location</th>
                        <th>Status</th>
                        <th>Action</th>

                    </tr>
                    </thead>
                    <tbody id="visit-ledger-tbody">

                    <tr v-for="visitList in visitLedgerList">
                        <td>{{visitList.username}}-{{visitList.firstName}}</td>
                        <td>{{formatDate(visitList.dateOfVisit)}}</td>
                        <td>{{visitList.visitTime}}</td>
                        <td>{{visitList.location}}</td>
                        <td>{{visitList.status}}</td>
                        <td>
                            <a class="btn btn-xs btn-info"><i id="view-visit-ledger" v-bind:data-id="visitList.id" data-toggle="modal" data-target="#modal-visit-ledger-view" class="fa fa-eye"></i></a>
                            <a :disabled="visitList.status == 'PENDING'" class="btn btn-xs btn-info"><i class="fa fa-edit" id="edit-visit-ledger" v-bind:data-id="visitList.id" data-toggle="modal" data-target="#visitLedgerModal"></i></a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    </div>
    <script>
        $(document).ready(function () {
            $('#visit-ledger-from-id input[name="_csrf"]').val(csrfToken);
            $('#visit-ledger-from-id input[name="accountCardNumber"]').val(accountNo);

            visitLedgerApp = new Vue({
                el: '#visit-ledger-view-id',
                data: {
                    visitLedgerList: [],
                    visitLedger: {},
                    accountNo: accountNo,
                    loanAccInfo: {},
                    customerAddressList: [],
                    customerInfo: {},
                    homeAddress: '',
                    permanentAddress: '',

                    allAddress: []
                },
                methods: {
                    /*formatDateInput: function (date) {
                        let date1 = date ? new Date(date) : new Date()

                        return date ? date1.getFullYear()
                            + '-' + ((date1.getMonth() + 1) < 10 ? '0' + (date1.getMonth() + 1) : (date1.getMonth() + 1))
                            + '-' + (date1.getDate() < 10 ? '0' + date1.getDate() : date1.getDate())
                            : '';
                    },*/
                    formatDate: function (date) {
                        return formatDate_DD_MMM_YYYY(date)
                    },

                    resetForm: function () {
                        var formdatalist = $('#visit-ledger-from-id');
                        formdatalist.find('input[name="id"]').val('');
                        // formdatalist.find('input[name="accountCardNumber"]').val(response.accountCardNumber);
                        // formdatalist.find('input[name="productUnit"]').val(response.productUnit);
                        formdatalist.find('input[name="dateOfVisit"]').val('');
                        formdatalist.find('input[name="visitTime"]').val('');
                        formdatalist.find('input[name="location"]').val('');
                        formdatalist.find('textarea[name="remark"]').val('');
                    }
                }


            })

            function isValidDate(dateString_yyyy_mm_dd) {
                if (typeof dateString_yyyy_mm_dd === 'string') {
                    return dateString_yyyy_mm_dd.match(/^\d{4}-([01]?[0-9])-([0-2]?[0-9])$/) ||
                        dateString_yyyy_mm_dd.match(/(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+)|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d)|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d)/) ||
                        dateString_yyyy_mm_dd.match(/(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))/);
                } else if (dateString_yyyy_mm_dd && typeof dateString_yyyy_mm_dd.getMonth === 'function') {
                    return true;
                }
                return false;
            }

            function endureTwoDigitDay(value) {
                if (!value) return '';
                value = value.toString();
                if (value.length < 2)
                    value = '0' + value;
                else if (value.length > 2)
                    value = value.substr(0, 2);
                return value;
            }

            const shortMonthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            function formatDate_DD_MMM_YYYY(dateString_yyyy_mm_dd, delimeter = ".") {
                //console.log("ptp date : "+dateString_yyyy_mm_dd)
                if (!isValidDate(dateString_yyyy_mm_dd)) return dateString_yyyy_mm_dd;
                let date = new Date(dateString_yyyy_mm_dd);
                return endureTwoDigitDay(date.getDate()) + delimeter + shortMonthNames[date.getMonth()] + delimeter + date.getFullYear();
            }

            $('#visit-ledger-tbody').delegate('#edit-visit-ledger','click', function () {
                $.ajax({
                    url: '/collection/visitledger/find/visit-ledger?id='+$(this).data("id"),
                    success: function (response) {
                        var formdatalist = $('#visit-ledger-from-id');
                        formdatalist.find('input[name="id"]').val(response.id);
                        // formdatalist.find('input[name="accountCardNumber"]').val(response.accountCardNumber);
                        // formdatalist.find('input[name="productUnit"]').val(response.productUnit);
                        formdatalist.find('input[name="dateOfVisit"]').val(response.dateOfVisit);
                        formdatalist.find('input[name="visitTime"]').val(response.visitTime);
                        formdatalist.find('input[name="location"]').val(response.location);
                        formdatalist.find('textarea[name="remark"]').val(response.remark);
                        $('#visitLedgerModal').modal('show');
                    }
                })
            })

            function getvisitLegerdata(accountNo){
                $.ajax({
                    url: '/collection/visitledger/list1?accountNo='+accountNo,
                    success: function (response) {
                        console.log(response)
                        visitLedgerApp.visitLedgerList = response;
                    },
                    error: function (response) {
                        alert('Unsuccessful');
                    }
                })
            }

            getvisitLegerdata(accountNo);

            $('#visit-ledger-from-id').on('submit', function (event) {
                event.preventDefault();
                var  visitData = new FormData(this);

                $.ajax({
                    type: "POST",
                    url: "/collection/visitledger/create/visit-ledger",
                    data: visitData,
                    enctype: 'multipart/form-data',
                    contentType: false,
                    processData: false,
                    headers: {
                        'X-CSRF-TOKEN': window.csrfToken,
                    },
                    success: function (data) {
                        //swal("Success!", "Successfully Saved!", "success");
                        // $('#vehicleRepossessionForm')[0].reset();
                        alert('Successful');
                        $('visitTime,location,remark,dateOfVisit').val('');
                        $('#visitLedgerCardModal').modal('toggle');
                        getvisitLegerdata(data.accountCardNumber);
                    },
                    error: function (error) {
                        console.log(error);
                    }
                })
            })

/*            function formatDateInput(date) {
                let date1 = date ? new Date(date) : new Date()

                return date ? date1.getFullYear()
                    +'-'+((date1.getMonth()+1) < 10 ? '0'+(date1.getMonth()+1) : (date1.getMonth()+1))
                    +'-'+(date1.getDate() < 10 ? '0'+date1.getDate() : date1.getDate())
                    : '';

            }*/


            $('#visit-ledger-tbody').delegate('#view-visit-ledger', 'click', function () {
                $.ajax({
                    url: '/collection/visitledger/find/visit-ledger?id='+$(this).data("id"),
                    success: function (response) {
                        $('#supervisor-visitledger-remark').val(response.remark);
                        $('#modal-supervisor-visit-ledger-view').modal('show');
                    },
                    error: function (response) {
                        console.log(response);
                    }
                })
            })


            $('#tab-Visit-Ledger').click(function () {
                console.log(cId);
                $.ajax({
                    url: '/loan/api/customer-other-info/find?customerId='+cId,
                    success: function (response) {
                        console.log(response);
                        visitLedgerApp.allAddress.push(response.homeAddress);
                        visitLedgerApp.allAddress.push(response.officeAddress);
                        visitLedgerApp.allAddress.push(response.permanentAddress);
                    },
                    error: function (response) {
                        alert('Unsuccessful');
                    }
                })
            })
        })
    </script>
</div>
</body>
</html>
