<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="card/layouts/main/main-layout">
<head>
    <meta charset="utf-8"/>
    <title>Send SMS Section</title>
</head>
<body>
<div layout:fragment="content" th:remove="tag">
    <div class="content-wrapper">

        <section class="content">
            <div class="row">
                <div class="col-xs-12">
                    <div class="box">

                        <div class="box-header with-border" style="text-align: center">
                            <h3 class="box-title">Generate SMS</h3>
                        </div>
                        <!-- /.box-header -->
                        <div id="app" class="box-body">
                            <div class="form-group" style="margin: 0 0 20px 15px">
                                <input type="hidden" id="csrf_token" name="_csrf"/>
                                <div class="col-sm-12">
                                    <div class="col-sm-3 text-right"><label class="control-label required">SMS Type </label></div>
                                    <div class="col-sm-6">
                                        <!--<select class="form-control"> &lt;!&ndash; th:field="*{category}&ndash;&gt;-->
                                        <!--<option class="form-control required">Select a SMS Type</option>-->
                                        <!--<option th:each="sms: ${smsEntityList}"  th:value="${sms.name}"  th:text="${sms.name}" ></option>-->
                                        <!--</select>-->
                                        <select name="letterType" v-model="letterType" id="letterType" class="form-control required" required>
                                            <option class="form-control required" value="" selected>Select a Letter Type</option>
                                            <option th:each="sms : ${smsEntityList}" th:value="${sms.getId()}" th:text="${sms.getName()}"></option>
                                        </select>

                                    </div>
                                </div>
                                <div class="col-sm-12 text-center" style="margin: 15px;">
                                    <button @click="generateSms" id="latterGenarateId" class="btn btn-primary" style="padding: 5px;">Generate</button>
                                </div>

                            </div>


                            <table id="smstable" name="datatable-responsive" class="table table-striped table-bordered table-condensed" width="100%">
                                <thead>
                                <tr>
                                    <th>Checkbox</th>
                                    <th>Account No</th>
                                    <th>Customer Name</th>
                                    <th>Mobile Number</th>
                                    <th>Action</th>
                                </tr>
                                </thead>

                                <tbody id="latterGenaratedTBodyId">
                                <tr v-for="loan, index in accountNoLList" >
                                    <td >
                                        <label>
                                            <input :id="'loan-' + index" type="checkbox"
                                                   class="mdl-checkbox__input" @click="getData(loan,index)">
                                        </label></td>

                                    <td >{{loan.accountNo}}</td>
                                    <td>
                                        <div style="height: 16px; overflow: auto">
                                            {{loan.customerName}}
                                        </div>
                                    </td>
                                    <td>{{loan.mobileNo}}</td>
                                    <td style="min-width: 140px;" v-if="selectedList.includes(loan.accountNo)">

                                        <button class="btn btn-primary btn-preview">
                                            <a style="color: white"
                                               rel="noopener noreferrer" target="_blank">preview</a>

                                        </button>
                                        <button class="btn btn-primary" @click="sendSms(loan.accountNo, index+1)" id="sendSms">send</button>
                                    </td>

                                </tr>
                                </tbody>
                            </table>

                            <form th:method="POST" class="hidden form-send-sms" th:action="@{/collection/generate/sms/generate}">
                                <input type="hidden" name="account" v-bind:value="selectedList">
                                <input type="hidden" name="letterType" v-bind:value="letterType">
                                <input type="hidden" name="mobileNo" v-bind:value="selectedMobileNo">
                            </form>



                        </div>

                        <script th:inline="javascript">
                            /*<![CDATA[*/
                            var accountNoLList = /*[[${loanviewlist}]]*/   [];
                            /*]]>*/
                        </script>


                        <script>
                            $('#smstable').DataTable();
                            var arr = [];

                            var smsApp = new Vue({
                                el: "#app",
                                data: {
                                    generateViaExcel: false,
                                    errors: [],

                                    loanViewList: [],
                                    tempViewList: [],
                                    excelViewList: [],
                                    accountNoLList: [],

                                    selectedList: [],
                                    dealerId: "",
                                    dualType: "SINGLE",
                                    agencyId: "",
                                    LettergenErr: false,
                                    generated: false,
                                    LettergenErrMsg: [],
                                    selectedAccount: '',
                                    letterType: '',
                                    mobileNo:'',
                                    selectedMobileNo:[],
                                    letterTypeText: '',
                                    unit: '',
                                    smsContent:{
                                        accountNo:'',
                                        mobileNo:''
                                    },
                                    sendLetter: false,
                                    letterModel:{
                                        dispatcherNumber:''
                                    }
                                },

                                created: function () {
                                    this.accountNoLList = accountNoLList ? accountNoLList: [];
                                },

                                methods: {
                                    getData(loan,index) {

                                        var l = loan.accountNo+"-"+loan.mobileNo+"-"+loan.productName+"-"
                                            +loan.installmentAmount+"-"+loan.nextEmiDate+"-"+loan.currentMonth+
                                            "-"+loan.customerId+"-"+loan.customerName;
                                        if(arr.indexOf(index) == -1){
                                            arr.push(index);
                                            this.selectedList.push(l);
                                        }
                                        else{
                                            this.selectedList = this.selectedList.splice(this.selectedList.indexOf(l)-1,this.selectedList.indexOf(l));
                                            arr = arr.slice(arr.indexOf(index)-1,arr.indexOf(index));
                                        }
                                    },
                                    generateSms(){
                                        if(this.selectedList.length == 0){
                                            alert("Select a account.");
                                            return;
                                        }

                                        if(!this.letterType){
                                            alert("Select a letter type.")
                                            return;
                                        }
                                        var token = $("meta[name='_csrf']").attr("content");
                                        var header = $("meta[name='_csrf_header']").attr("content");
                                        $.ajax({
                                            url:"/collection/generator/generatesms?accountNo="+this.selectedList+"&smsType="+this.letterType,
                                            type: 'POST',
                                            contentType: "application/json; charset=utf-8",
                                            dataType   : "json",
                                            beforeSend: function (xhr) {
                                                xhr.setRequestHeader(header, token);
                                            },
                                            success: function (data) {
                                                console.log("vdxgdxvdx")
                                                console.log(data)
                                            },
                                            error: function (err) {
                                            }

                                        });
                                    },
                                    previewLetter() {
                                        if(this.letterType=='retail_due_0-3' || this.letterType=='retail_due_4-6' || this.letterType=='retail_due_7' || this.letterType=='retail_due_8' || this.letterType=='retail_gurantor_letter' || this.letterType=='retail_repossession' || this.letterType=='retail_warning_letter' || this.letterType=='sme_due_0_6' || this.letterType=='sme_due_7_10' || this.letterType=='sme_due_11' || this.letterType=='sme_due_12' || this.letterType=='sme_gurantor_letter' || this.letterType=='sme_warning_letter' || this.letterType=='retail_brta_reject' || this.letterType=='retail_brta_allow'){
                                            $('#retail_due_0_3').modal('show');
                                        }else if(this.letterType=='retail_employee_assistance'){
                                            $('#retail_employee_assistance').modal('show');
                                        }

                                        this.LettergenErrMsg = [];
                                        if (!this.letterType.length) {
                                            this.LettergenErrMsg.push('Select Letter Type');
                                        }
                                        if (!this.selectedList.length) {
                                            this.LettergenErrMsg.push('Select at least one account');
                                        }
                                        this.LettergenErr = this.LettergenErrMsg.length;
                                        this.generated = !this.LettergenErr;
                                    },

                                    generateLetter: function () {
                                        if(this.selectedList.length == 0){
                                            alert("Select a account.");
                                            return;
                                        }

                                        if(!this.letterType){
                                            alert("Select a letter type.")
                                            return;
                                        }
                                        $('#form-generate-bulk').submit();
                                    },
                                    // changeGenerationType: function() {
                                    //     this.generateViaExcel = !this.generateViaExcel;
                                    // },
                                    importViaExcel: function() {
                                        let form = $('#import-excel');

                                        $.ajax({
                                            type: 'POST',
                                            encType: form.prop('enctype'),
                                            contentType: false,
                                            processData: false,
                                            url: form.prop('action'),
                                            data: new FormData(form[0]),
                                            dataType: 'JSON',
                                            success: function (response) {
                                                if(response.outcome == 'success'){

                                                    letterApp.errors = [];
                                                }
                                                else{
                                                    letterApp.errors = response.errors;
                                                }
                                            },
                                            error: function () {
                                                alert("failed")
                                            }
                                        })
                                    },
                                    letterType: function(){
                                        this.letterTypeText = $('#letterType option[value="'+this.letterType+'"]').text();
                                    },
                                    sendSms: function (accountNo, index) {

                                        console.log(smsApp.letterType)
                                        smsApp.smsContent.accountNo =  smsApp.accountNoLList[index-1].accountNo;
                                        let mobileNo = smsApp.mobileNo;
                                        let letterType = smsApp.letterType;

                                        if(!smsApp.letterType){
                                            alert("Select a letter type.")
                                            return;
                                        }

                                        if(!smsApp.mobileNo){
                                            alert("No phone no!, Please insert phone no.")
                                            return ;
                                        }

                                        let iframe = document.createElement('iframe')
                                        let srcValue = '/collection/generate/sms/generate?account=' + accountNo + '&letterType='+ letterType +'&mobile='+mobileNo;
                                        iframe.setAttribute('src', srcValue);
                                        iframe.setAttribute('style', 'width: 100%; display: none;');

                                        document.body.appendChild(iframe)

                                        iframe.addEventListener('load', function (ev) {
                                            let htmlText = $('iframe').contents().find('#letter-editor').html();

                                            smsApp.smsContent.emailSubject = $('iframe').contents().find('#email-subject').text().split('Subject:').join('');
                                            smsApp.smsContent.emailBody = htmlText;
                                            smsApp.sendLetter = !smsApp.sendLetter;

                                            $('iframe').remove();
                                        })
                                    },
                                }
                            });

                            $('#dispatcherId1, #dispatcherId2').click(function () {

                                var token = csrfToken;
                                console.log(token)
                                var header = $("meta[name='_csrf_header']").attr("content");

                                var latterType = $('#letterType').val();
                                var a = letterApp.selectedList;
                                reId1 = letterApp.letterModel.dispatcherNumber;
                                var refeId = 'CHO/CRMD/'+new Date().getFullYear()+'/'+ reId1;
                                console.log(refeId);
                                jsonArray = [];
                                for (var i = 0; i<a.length; i++){
                                    latter = {};

                                    latter ["accountNo"] = a[i];
                                    latter ["latterType"] = latterType;
                                    latter ["referenceId"] = refeId;

                                    jsonArray.push(latter);
                                }
                                json = JSON.stringify(jsonArray)

                                url = "/collection/settings/issueletter/generated-letter";
                                $.ajax({
                                    type: "POST",
                                    url: url,
                                    data: json,
                                    contentType: 'application/json',
                                    dataType: 'json',
                                    beforeSend: function (xhr) {xhr.setRequestHeader(header, token);
                                    },
                                    success: function (data) {
                                        console.log('Successfull')
                                    },
                                    error: function (error) {
                                        console.log(error);
                                    }
                                });
                            });
                        </script>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>
</body>
</html>