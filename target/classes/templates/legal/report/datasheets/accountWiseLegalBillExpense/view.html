<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="legal/layouts/main/main-layout">
<head>
    <meta charset="UTF-8">
    <title th:text="${reportTitle}"></title>
    <link rel="stylesheet" href="/css/datatables-utils/buttons.dataTables.min.css">
</head>
<body>
<div layout:fragment="content">
    <div class="content-wrapper">
        <div class="content">
            <div class="row">
                <div class="col-xs-12" id="account-wise-bill-app">
                    <div class="box box-info">
                        <div class="box-header with-border text-center">
                            <div class="box-title" th:text="${reportTitle}"></div>
                        </div>

                        <div class="box-body">
                            <div class="row">
                                <div class="col-sm-12">
                                    <div class="form-horizontal padding-top-20">
                                        <div class="col-sm-6">
                                            <div class="form-group">
                                                <label class="col-sm-4 padding-top-6 text-right">Month</label>
                                                <div class="col-sm-8">
                                                    <input name="month" v-model="selectedMonth" type="month" class="form-control" style="border-radius: 5px">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-sm-5 text-right">
                                            <button type="button" class="btn btn-info" @click="searchData">Run Report</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!--<div class="text-right margin-bottom" v-if="billLists.length">
                        <button class="btn btn-primary btn-generate-pdf">
                            <span>Export to PDF</span>
                            <span class="glyphicon glyphicon-download-alt" ></span>
                        </button>
                    </div>-->

                    <div class="box box-info" id="pdf-box">
                        <div class="box-body">
                            <div class="box-header with-border text-center">
                                <div class="box-title" th:text="${reportTitle}"></div>
                            </div>

                            <div class="table-responsive">
                                <table id="bill-table" class="table table-striped table-bordered table-condensed text-center">
                                    <thead>
                                        <tr>
                                            <th>SL#</th>
                                            <th>Branch Code</th>
                                            <th>Branch Name</th>
                                            <th>CID ID</th>
                                            <th>Account No</th>
                                            <th>Account Name</th>
                                            <th>Segment</th>
                                            <th>Outstanding</th>
                                            <th>This Month Recovery (before filling)</th>
                                            <th>This Month Recovery (afrter filling)</th>
                                            <th>Cumulative Recovery</th>
                                            <th>Disctrict</th>
                                            <th>Court Name</th>
                                            <th>Lawyer's ID</th>
                                            <th>Lawyer's Name</th>
                                            <th>Lawyer's Mobile No</th>
                                            <th>Plaintiff/Petitioner EID</th>
                                            <th>Plaintiff/Petitioner Name</th>
                                            <th>Plaintiff/Petitioner Mobile No</th>
                                            <th>Lawyer's Bill for Type of Case</th>
                                            <th>Case Status</th>
                                            <th>Previous Month Lawyer's Bill Amt</th>
                                            <th>Current Month Lawyer's Bill Amt</th>
                                            <th>Total Lawyer's Bill Amount</th>
                                            <th>Current Month Others Bill Amount</th>
                                            <th>Total Others Bill Amount</th>
                                            <th>Cumulative Legal Bill/Expense Amt</th>
                                            <th>Current Month Legal Bill/Exp. Recovery</th>
                                            <th>Cumulative Legal Bill/Exp. Recovery</th>
                                            <th>Cl Status</th>
                                            <th>Outstanding</th>
                                            <th>Recovery Before Case Filing</th>
                                            <th>Recovery After Case Filing</th>
                                            <th>Cumulative Recovery</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="bill in billLists">
                                            <td>{{bill.serial}}</td>
                                            <td>{{bill.branchCode}}</td>
                                            <td>{{bill.branchName}}</td>
                                            <td>{{bill.cifId}}</td>
                                            <td>{{bill.accountNo}}</td>
                                            <td>{{bill.accountName}}</td>
                                            <td>{{bill.segment}}</td>
                                            <td>{{bill.outstanding}}</td>
                                            <td>{{bill.thisMonthRecoveryBeforeFiling}}</td>
                                            <td>{{bill.thisMonthRecoveryAfterFiling}}</td>
                                            <td>{{bill.cumulativeRecovery}}</td>
                                            <td>{{bill.district}}</td>
                                            <td>{{bill.courtName}}</td>
                                            <td>{{bill.lawyersId}}</td>
                                            <td>{{bill.lawyersName}}</td>
                                            <td>{{bill.lawyersMobileNo}}</td>
                                            <td>{{bill.plaintiffId}}</td>
                                            <td>{{bill.plaintiffName}}</td>
                                            <td>{{bill.plaintiffMobileNo}}</td>
                                            <td>{{bill.lawyersBillForTypeOfCase}}</td>
                                            <td>{{bill.caseStatus}}</td>
                                            <td>{{bill.previousMonthLawyersBillAmount}}</td>
                                            <td>{{bill.currentMonthLawyersBillAmount}}</td>
                                            <td>{{bill.previousMonthLawyersBillAmount + bill.currentMonthLawyersBillAmount}}</td>
                                            <td>{{bill.currentMonthOthersBillAmount}}</td>
                                            <td>{{bill.totalOthersBillAmount}}</td>
                                            <td>{{bill.cumulativeLegalBillAmount}}</td>
                                            <td>{{bill.currentMonthLegalBillRecovery}}</td>
                                            <td>{{bill.cumulativeLegalBillRecovery}}</td>
                                            <td>{{bill.clStatus}}</td>
                                            <td>{{bill.outstanding}}</td>
                                            <td>{{bill.recoveryBeforeCaseFiling}}</td>
                                            <td>{{bill.recoveryAfterCaseFiling}}</td>
                                            <td>{{bill.cumulativeRecovery}}</td>
                                        </tr>
                                    </tbody>

                                    <tfoot>
                                        <tr>
                                            <td>Total</td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td>{{formatDecimal(totalOutstanding)}}</td>
                                            <td>{{formatDecimal(totalThisMonthRecoveryBeforeFiling)}}</td>
                                            <td>{{formatDecimal(totalThisMonthRecoveryAfterFiling)}}</td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td>{{formatDecimal(totalPreviousMonthLawyersBillAmount)}}</td>
                                            <td>{{formatDecimal(totalCurrentMonthLawyersBillAmount)}}</td>
                                            <td>{{formatDecimal(totalPreviousMonthLawyersBillAmount+totalCurrentMonthLawyersBillAmount)}}</td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td>{{formatDecimal(totalCurrentMonthLegalBillRecovery)}}</td>
                                            <td></td>
                                            <td></td>
                                            <td>{{formatDecimal(totalOutstanding)}}</td>
                                            <td>{{formatDecimal(totalRecoveryBeforeCaseFiling)}}</td>
                                            <td>{{formatDecimal(totalRecoveryAfterCaseFiling)}}</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>

                        </div>
                    </div>
                </div>

                <script>
                    accountWiseBillApp = new Vue({
                        el: '#account-wise-bill-app',
                        data: {
                            billLists: [],
                            selectedMonth: '',
                            totalOutstanding: 0,
                            totalThisMonthRecoveryBeforeFiling: 0,
                            totalThisMonthRecoveryAfterFiling: 0,
                            totalPreviousMonthLawyersBillAmount: 0,
                            totalCurrentMonthLawyersBillAmount: 0,
                            totalOutstanding: 0,
                            totalRecoveryBeforeCaseFiling: 0,
                            totalRecoveryAfterCaseFiling: 0,
                            totalCurrentMonthLegalBillRecovery: 0
                        },
                        methods: {
                            searchData: function () {
                                if (this.selectedMonth){
                                    $.ajax({
                                        url: '/legal/report/account-wise-legal-bill-expense/search?month='+this.selectedMonth,
                                        type: 'get',
                                        contentType: 'application/json;charset=UTF-8',
                                        success: function(response) {
                                            table.destroy();
                                            table = "";
                                            accountWiseBillApp.billLists = response;


                                            accountWiseBillApp.totalOutstanding = 0
                                            accountWiseBillApp.totalThisMonthRecoveryBeforeFiling = 0
                                            accountWiseBillApp.totalThisMonthRecoveryAfterFiling = 0
                                            accountWiseBillApp.totalPreviousMonthLawyersBillAmount = 0
                                            accountWiseBillApp.totalCurrentMonthLawyersBillAmount = 0
                                            accountWiseBillApp.totalOutstanding = 0
                                            accountWiseBillApp.totalRecoveryBeforeCaseFiling = 0
                                            accountWiseBillApp.totalRecoveryAfterCaseFiling = 0
                                            accountWiseBillApp.totalCurrentMonthLegalBillRecovery = 0

                                            accountWiseBillApp.getCalculateData();
                                        }
                                    })
                                }
                            },
                            formatDate: function (data) {
                                if (data){
                                    var monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
                                    var fullDate = new Date(data);
                                    var date  = fullDate.getDate() < 10 ? '0' + fullDate.getDate() : fullDate.getDate();
                                    var month = fullDate.getMonth();


                                    return date + '-' + monthNames[month] + '-' + fullDate.getFullYear()
                                }
                            },
                            formatDecimal: function (data) {
                                if (Number(data)) {
                                    return data.toFixed(2)
                                }
                                else
                                    return '0.00'
                            },
                            getCalculateData: function () {
                                $.each(this.billLists, function () {
                                    accountWiseBillApp.totalThisMonthRecoveryBeforeFiling += Number(this.thisMonthRecoveryBeforeFiling)
                                    accountWiseBillApp.totalThisMonthRecoveryAfterFiling += Number(this.thisMonthRecoveryAfterFiling)

                                    accountWiseBillApp.totalPreviousMonthLawyersBillAmount += Number(this.previousMonthLawyersBillAmount)
                                    accountWiseBillApp.totalCurrentMonthLawyersBillAmount += Number(this.currentMonthLawyersBillAmount)
                                    accountWiseBillApp.totalOutstanding += Number(this.outstanding)

                                    accountWiseBillApp.totalCurrentMonthLegalBillRecovery += Number(this.currentMonthLegalBillRecovery)
                                    accountWiseBillApp.totalRecoveryBeforeCaseFiling += Number(this.recoveryBeforeCaseFiling)
                                    accountWiseBillApp.totalRecoveryAfterCaseFiling += Number(this.recoveryAfterCaseFiling)
                                })
                            }
                        },
                        updated: function () {
                            initTable();
                        }
                    })

                    var table;
                    function initTable() {
                        if (!table){
                            table = $('#bill-table').DataTable( {
                                dom: 'Bfrtip',
                                buttons: ['csv', 'excel', 'print']
                            });
                        }
                    }

                    $(document).ready(function () {
                        initTable();
                    })

                    $('body').delegate('.btn-generate-pdf', 'click', () => {
                        printElementIncludingStyles('pdf-box')
                    })
                </script>
            </div>
        </div>
    </div>
</div>
</body>
</html>