<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="card/layouts/main/main-layout">
<head>
    <meta charset="UTF-8">
    <title>Card Distribution</title>
</head>
<body>
<div layout:fragment="content">
    <div class="content-wrapper">
        <div class="content">
            <div class="row" id="loan-acc-distribution-app">
                <div class="col-xs-12">
                    <div class="box">
                        <div class="box-header with-border">
                            <div class="box-title">SAM Card Distribution</div>
                            <a th:href="${'/collection/samd/card-distribution/manual'}" class="btn btn-primary btn-sm pull-right">
                                <i class="fa fa-plus"></i>
                                <span>Manual Card Distribution</span>
                            </a>
                            <button :disabled="selected.length == 0" class="btn btn-primary btn-sm pull-right margin-r-5" data-toggle="modal" data-target="#sam-manual-allocation-dealer">
                                <i class="fa fa-plus"></i>
                                <span>MA (Dealer)</span>
                            </button>
                        </div>

                        <div class="box-body">
                            <div class="table-responsive">
                                <table id="example" name="datatable-responsive" class="table table-striped table-bordered">
                                    <thead>
                                        <th></th>
                                        <th th:text="${'SL.'}"></th>
                                        <th th:text="${'CONTRACT ID'}"></th>
                                        <th th:text="${'CUSTOMER ID'}"></th>
                                        <th th:text="${'DEALER ID'}"></th>
                                        <th th:text="${'DEALER NAME'}"></th>
                                    </thead>

                                    <tbody>
                                        <tr v-for="(distribution, index) in distributions">
                                            <td><input type="checkbox" :id="distribution.id" v-model="selected" :value="distribution.id"></td>
                                            <td>{{index+1}}</td>
                                            <td>{{distribution.contractId}}</td>
                                            <td>{{distribution.customerId}}</td>
                                            <td>{{distribution.dealerId}}</td>
                                            <td>{{distribution.dealerName}}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="sam-manual-allocation-dealer" data-backdrop="static" class="modal fade in">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button class="close"  data-dismiss="modal">&times;</button>
                                    <h5 class="modal-title">Manual Allocation (Dealer)</h5>
                                </div>

                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-sm-10 col-sm-offset-1">
                                            <div class="alert alert-warning" v-if="errors.length">
                                                <div v-for="(error, index) in errors">{{index+1}}. {{error}}</div>
                                            </div>

                                            <div class="form-horizontal">
                                                <div class="form-group">
                                                    <label class="col-sm-3 required">Dealer</label>
                                                    <div class="col-sm-9">
                                                        <select id="dealer" name="dealer" class="form-control input-sm">
                                                            <option value="">Choose One
                                                            </option>
                                                            <option th:each="dealer : ${dealers}" th:value="${dealer.id}" th:text="${dealer.getUser().getFirstName()}"></option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="modal-footer">
                                    <button type="button" class="btn btn-default btn-sm pull-left" data-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-success btn-sm btn-submit-ma-dealer" >Submit</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <script th:inline="javascript">
                /*<![CDATA[*/
                let distributions = /*[[${distributions}]]*/ "";
                /*]]>*/

                let loanDistributionApp = new Vue({
                    el: "#loan-acc-distribution-app",
                    data: {
                        selected: [],
                        dealerId: '',
                        distributions: distributions,
                        errors: []
                    }
                });

                $('#dealer').on('change', function () {
                    loanDistributionApp.dealerId = $(this).val()
                })

                $('.btn-submit-ma-dealer').click(function () {
                    $.ajax({
                        url: '/collection/samd/card-distribution/manual-dealer-allocation',
                        type: 'post',
                        contentType: 'application/json;charset=UTF-8',
                        headers: {'X-CSRF-TOKEN' : window.csrfToken},
                        data: JSON.stringify({
                            'dealerId': loanDistributionApp.dealerId,
                            'selectedIds': loanDistributionApp.selected
                        }),
                        success: function(response, status, xhr) {
                            if (response.outcome == 'success')
                                window.location.reload();
                            else
                                loanDistributionApp.errors = response.errors
                        }
                    })
                })
            </script>
        </div>
    </div>
</div>


</body>
</html>